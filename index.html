<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üëÅ NIGHTMARE FACTORY ‚Äî YouTube Horror Automation</title>
<link href="https://fonts.googleapis.com/css2?family=Creepster&family=Special+Elite&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
  :root {
    --blood: #8b0000;
    --crimson: #dc143c;
    --ember: #ff4500;
    --ash: #1a1a1a;
    --bone: #e8e0d0;
    --fog: #2a2a2a;
    --ghost: #444;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #0a0a0a;
    color: var(--bone);
    font-family: 'Special Elite', cursive;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: 
      radial-gradient(ellipse at 20% 50%, rgba(139,0,0,0.08) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 20%, rgba(220,20,60,0.05) 0%, transparent 50%),
      radial-gradient(ellipse at 50% 80%, rgba(255,69,0,0.04) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
    animation: breathe 8s ease-in-out infinite;
  }

  @keyframes breathe {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
  }

  .noise {
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
    opacity: 0.4;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 960px;
    margin: 0 auto;
    padding: 20px;
  }

  /* HEADER */
  header {
    text-align: center;
    padding: 40px 0 30px;
    position: relative;
  }

  .skull { font-size: 2rem; animation: flicker 3s infinite; display: block; margin-bottom: 10px; }

  @keyframes flicker {
    0%, 95%, 100% { opacity: 1; }
    96% { opacity: 0.3; }
    97% { opacity: 1; }
    98% { opacity: 0.1; }
    99% { opacity: 0.8; }
  }

  h1 {
    font-family: 'Creepster', cursive;
    font-size: clamp(2rem, 6vw, 3.5rem);
    color: var(--crimson);
    text-shadow: 0 0 30px rgba(220,20,60,0.5), 0 0 60px rgba(139,0,0,0.3);
    letter-spacing: 4px;
    line-height: 1;
  }

  .tagline {
    font-family: 'Share Tech Mono', monospace;
    color: #666;
    font-size: 0.75rem;
    letter-spacing: 3px;
    margin-top: 8px;
    text-transform: uppercase;
  }

  .divider {
    border: none;
    border-top: 1px solid var(--blood);
    margin: 20px 0;
    opacity: 0.4;
    box-shadow: 0 0 10px rgba(139,0,0,0.3);
  }

  /* API KEY SECTION */
  .api-section {
    background: linear-gradient(135deg, #111 0%, #1a0a0a 100%);
    border: 1px solid #2a0a0a;
    border-left: 3px solid var(--blood);
    border-radius: 4px;
    padding: 20px;
    margin-bottom: 24px;
  }

  .section-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 3px;
    color: var(--crimson);
    text-transform: uppercase;
    margin-bottom: 10px;
  }

  .api-row {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  input[type="password"], input[type="text"], select, textarea {
    background: #0d0d0d;
    border: 1px solid #2a2a2a;
    color: var(--bone);
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.8rem;
    padding: 10px 14px;
    border-radius: 3px;
    outline: none;
    transition: border-color 0.3s;
    width: 100%;
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--blood);
    box-shadow: 0 0 10px rgba(139,0,0,0.2);
  }

  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #333;
    flex-shrink: 0;
    transition: all 0.3s;
  }
  .status-dot.connected { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
  .status-dot.error { background: var(--crimson); box-shadow: 0 0 8px var(--crimson); animation: pulse 1s infinite; }

  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

  /* CONTROLS */
  .controls-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 24px;
  }

  @media (max-width: 600px) { .controls-grid { grid-template-columns: 1fr; } }

  .control-box {
    background: linear-gradient(135deg, #111 0%, #130a0a 100%);
    border: 1px solid #1e1e1e;
    border-radius: 4px;
    padding: 16px;
  }

  select {
    cursor: pointer;
  }

  select option { background: #111; }

  /* GENERATE BUTTON */
  .generate-btn {
    width: 100%;
    padding: 18px;
    background: linear-gradient(135deg, var(--blood) 0%, #5a0010 100%);
    border: 1px solid var(--crimson);
    color: var(--bone);
    font-family: 'Creepster', cursive;
    font-size: 1.4rem;
    letter-spacing: 3px;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.3s;
    text-transform: uppercase;
    position: relative;
    overflow: hidden;
    margin-bottom: 24px;
  }

  .generate-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, transparent 0%, rgba(220,20,60,0.2) 100%);
    opacity: 0;
    transition: opacity 0.3s;
  }

  .generate-btn:hover::before { opacity: 1; }
  .generate-btn:hover { box-shadow: 0 0 30px rgba(220,20,60,0.4); transform: translateY(-1px); }
  .generate-btn:active { transform: translateY(0); }
  .generate-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  /* LOADING */
  .loading-bar {
    display: none;
    background: #111;
    border: 1px solid #222;
    border-radius: 3px;
    height: 4px;
    margin-bottom: 24px;
    overflow: hidden;
  }

  .loading-bar.active { display: block; }

  .loading-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--blood), var(--crimson), var(--ember));
    width: 0%;
    transition: width 0.5s ease;
    box-shadow: 0 0 10px var(--crimson);
  }

  .loading-text {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    color: #666;
    text-align: center;
    margin-bottom: 16px;
    display: none;
    letter-spacing: 2px;
  }
  .loading-text.active { display: block; }

  /* OUTPUT SECTIONS */
  .output-section {
    display: none;
    animation: fadeIn 0.6s ease;
  }

  .output-section.visible { display: block; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .output-card {
    background: linear-gradient(135deg, #0f0f0f 0%, #120808 100%);
    border: 1px solid #1e1212;
    border-radius: 4px;
    margin-bottom: 16px;
    overflow: hidden;
  }

  .card-header {
    background: linear-gradient(90deg, #1a0808 0%, #110505 100%);
    border-bottom: 1px solid #2a1010;
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .card-title {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 2px;
    color: var(--crimson);
    text-transform: uppercase;
  }

  .copy-btn {
    background: transparent;
    border: 1px solid #333;
    color: #888;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.6rem;
    padding: 4px 10px;
    cursor: pointer;
    border-radius: 2px;
    letter-spacing: 1px;
    transition: all 0.2s;
    text-transform: uppercase;
  }

  .copy-btn:hover { border-color: var(--crimson); color: var(--crimson); }
  .copy-btn.copied { border-color: #22c55e; color: #22c55e; }

  .card-body {
    padding: 16px;
    font-size: 0.9rem;
    line-height: 1.7;
    color: #ccc;
    white-space: pre-wrap;
    font-family: 'Special Elite', cursive;
  }

  .card-body.mono {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.8rem;
    color: #aaa;
  }

  /* TAGS */
  .tags-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 16px;
  }

  .tag {
    background: #1a0a0a;
    border: 1px solid #2a1010;
    color: #888;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.65rem;
    padding: 4px 10px;
    border-radius: 2px;
    letter-spacing: 1px;
  }

  /* STEPS */
  .steps-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
    padding: 16px;
  }

  .step-item {
    background: #0d0d0d;
    border: 1px solid #1e1e1e;
    border-radius: 3px;
    padding: 12px;
  }

  .step-num {
    font-family: 'Creepster', cursive;
    font-size: 1.5rem;
    color: var(--blood);
    display: block;
    margin-bottom: 4px;
  }

  .step-title {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.65rem;
    color: var(--crimson);
    letter-spacing: 1px;
    text-transform: uppercase;
    display: block;
    margin-bottom: 6px;
  }

  .step-desc {
    font-size: 0.75rem;
    color: #777;
    line-height: 1.5;
  }

  /* SCORE BARS */
  .score-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
    padding: 0 16px;
  }

  .score-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.65rem;
    color: #666;
    width: 120px;
    flex-shrink: 0;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .score-bar {
    flex: 1;
    height: 6px;
    background: #1a1a1a;
    border-radius: 3px;
    overflow: hidden;
  }

  .score-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--blood), var(--crimson));
    border-radius: 3px;
    box-shadow: 0 0 6px var(--crimson);
    transition: width 1s ease;
    width: 0%;
  }

  .score-val {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    color: var(--crimson);
    width: 30px;
    text-align: right;
  }

  /* RESET */
  .reset-btn {
    width: 100%;
    padding: 12px;
    background: transparent;
    border: 1px solid #2a2a2a;
    color: #555;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 2px;
    cursor: pointer;
    border-radius: 3px;
    margin-top: 8px;
    transition: all 0.3s;
    text-transform: uppercase;
  }
  .reset-btn:hover { border-color: #555; color: #999; }

  /* FOOTER */
  footer {
    text-align: center;
    padding: 30px 0;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.6rem;
    color: #333;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .error-msg {
    background: #1a0000;
    border: 1px solid var(--blood);
    color: #ff6b6b;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.75rem;
    padding: 12px 16px;
    border-radius: 3px;
    margin-bottom: 16px;
    display: none;
    letter-spacing: 1px;
  }
  .error-msg.visible { display: block; }

  /* HISTORY */
  .history-section {
    margin-top: 40px;
    margin-bottom: 20px;
  }

  .history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .history-title {
    font-family: 'Creepster', cursive;
    font-size: 1.4rem;
    color: var(--crimson);
    letter-spacing: 2px;
    text-shadow: 0 0 15px rgba(220,20,60,0.3);
  }

  .clear-history-btn {
    background: transparent;
    border: 1px solid #2a1010;
    color: #555;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.6rem;
    padding: 6px 12px;
    cursor: pointer;
    border-radius: 2px;
    letter-spacing: 1px;
    text-transform: uppercase;
    transition: all 0.2s;
  }
  .clear-history-btn:hover { border-color: var(--blood); color: #ff6b6b; }

  .history-empty {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    color: #333;
    text-align: center;
    padding: 30px;
    border: 1px dashed #1e1e1e;
    border-radius: 4px;
    letter-spacing: 2px;
  }

  .history-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 12px;
  }

  .history-card {
    background: linear-gradient(135deg, #0f0f0f 0%, #120808 100%);
    border: 1px solid #1e1212;
    border-radius: 4px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
  }

  .history-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: var(--blood);
    opacity: 0.6;
  }

  .history-card:hover {
    border-color: var(--blood);
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(139,0,0,0.2);
  }

  .history-card-title {
    font-family: 'Special Elite', cursive;
    font-size: 0.85rem;
    color: var(--bone);
    margin-bottom: 8px;
    line-height: 1.4;
    padding-left: 8px;
  }

  .history-card-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-left: 8px;
  }

  .history-card-date {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.6rem;
    color: #444;
    letter-spacing: 1px;
  }

  .history-card-type {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.6rem;
    color: var(--blood);
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .history-card-delete {
    position: absolute;
    top: 8px; right: 8px;
    background: transparent;
    border: none;
    color: #333;
    cursor: pointer;
    font-size: 0.8rem;
    padding: 2px 6px;
    border-radius: 2px;
    transition: color 0.2s;
    line-height: 1;
  }
  .history-card-delete:hover { color: var(--crimson); }

  .history-view-badge {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.55rem;
    color: #555;
    letter-spacing: 1px;
    margin-top: 8px;
    padding-left: 8px;
    text-transform: uppercase;
  }

  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.92);
    z-index: 1000;
    overflow-y: auto;
    padding: 20px;
  }
  .modal-overlay.active { display: block; }

  .modal-box {
    max-width: 860px;
    margin: 0 auto;
    background: #0f0f0f;
    border: 1px solid var(--blood);
    border-radius: 6px;
    overflow: hidden;
    animation: fadeIn 0.3s ease;
  }

  .modal-header {
    background: linear-gradient(90deg, #1a0808, #110505);
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--blood);
  }

  .modal-title {
    font-family: 'Creepster', cursive;
    font-size: 1.1rem;
    color: var(--crimson);
    letter-spacing: 2px;
  }

  .modal-close {
    background: transparent;
    border: 1px solid #333;
    color: #888;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.65rem;
    padding: 6px 12px;
    cursor: pointer;
    border-radius: 2px;
    letter-spacing: 1px;
    transition: all 0.2s;
    text-transform: uppercase;
  }
  .modal-close:hover { border-color: var(--crimson); color: var(--crimson); }

  .modal-body { padding: 20px; }

  .modal-section {
    margin-bottom: 20px;
    background: #0d0d0d;
    border: 1px solid #1e1e1e;
    border-radius: 3px;
    overflow: hidden;
  }

  .modal-section-header {
    background: #1a0808;
    padding: 10px 14px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.65rem;
    color: var(--crimson);
    letter-spacing: 2px;
    text-transform: uppercase;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-section-body {
    padding: 14px;
    font-size: 0.85rem;
    color: #ccc;
    white-space: pre-wrap;
    line-height: 1.7;
    font-family: 'Special Elite', cursive;
    max-height: 200px;
    overflow-y: auto;
  }

  .modal-section-body.mono {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.75rem;
  }

  .modal-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    padding: 14px;
  }

  .modal-copy-btn {
    background: transparent;
    border: 1px solid #333;
    color: #666;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.55rem;
    padding: 3px 8px;
    cursor: pointer;
    border-radius: 2px;
    letter-spacing: 1px;
    transition: all 0.2s;
    text-transform: uppercase;
  }
  .modal-copy-btn:hover { border-color: var(--crimson); color: var(--crimson); }
  .modal-copy-btn.copied { border-color: #22c55e; color: #22c55e; }

  /* VOICEOVER PLAYER */
  .voice-card {
    background: linear-gradient(135deg, #0f0f0f 0%, #080d12 100%);
    border: 1px solid #0a1a2a;
    border-left: 3px solid #1a4a8a;
    border-radius: 4px;
    margin-bottom: 16px;
    overflow: hidden;
  }
  .voice-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 16px;
    align-items: center;
  }
  .voice-select {
    flex: 1;
    min-width: 160px;
    background: #0d0d0d;
    border: 1px solid #1a3a5a;
    color: var(--bone);
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.75rem;
    padding: 8px 12px;
    border-radius: 3px;
  }
  .voice-btn {
    background: linear-gradient(135deg, #1a3a6a, #0d2040);
    border: 1px solid #2a5a9a;
    color: #8ab4d4;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    padding: 8px 16px;
    cursor: pointer;
    border-radius: 3px;
    letter-spacing: 1px;
    transition: all 0.2s;
    text-transform: uppercase;
    white-space: nowrap;
  }
  .voice-btn:hover { background: linear-gradient(135deg, #1e4a8a, #102a50); box-shadow: 0 0 12px rgba(42,90,154,0.3); }
  .voice-btn.playing { background: linear-gradient(135deg, #1a5a1a, #0d3010); border-color: #2a8a2a; color: #8ad48a; }
  .voice-speed { width: 80px; }
  .voice-status {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.65rem;
    color: #555;
    padding: 0 16px 12px;
    letter-spacing: 1px;
  }

  /* EXPORT BUTTONS */
  .export-row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 16px;
  }
  .export-btn {
    flex: 1;
    min-width: 140px;
    padding: 12px 16px;
    border-radius: 3px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
    text-align: center;
    border: 1px solid;
  }
  .export-btn-srt {
    background: linear-gradient(135deg, #1a2a0a, #0d1805);
    border-color: #3a5a1a;
    color: #8ab44a;
  }
  .export-btn-srt:hover { box-shadow: 0 0 12px rgba(58,90,26,0.4); transform: translateY(-1px); }
  .export-btn-zip {
    background: linear-gradient(135deg, #1a1a2a, #0d0d1a);
    border-color: #3a3a8a;
    color: #8a8ad4;
  }
  .export-btn-zip:hover { box-shadow: 0 0 12px rgba(58,58,138,0.4); transform: translateY(-1px); }
  .export-btn-txt {
    background: linear-gradient(135deg, #2a1a0a, #1a0d05);
    border-color: #8a4a1a;
    color: #d4944a;
  }
  .export-btn-txt:hover { box-shadow: 0 0 12px rgba(138,74,26,0.4); transform: translateY(-1px); }

  /* MUSIC OPTIONS */
  .music-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 8px;
    padding: 16px;
  }
  .music-chip {
    background: #0d0d0d;
    border: 1px solid #1e1e1e;
    border-radius: 3px;
    padding: 10px 12px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.65rem;
    color: #666;
    letter-spacing: 1px;
    text-align: center;
  }
  .music-chip:hover, .music-chip.active {
    border-color: var(--blood);
    color: var(--crimson);
    background: #1a0808;
  }
  .music-prompt-output {
    padding: 0 16px 16px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.75rem;
    color: #888;
    line-height: 1.6;
    display: none;
  }
  .music-prompt-output.visible { display: block; }

</style>
</head>
<body>
<div class="noise"></div>

<div class="container">
  <header>
    <span class="skull">üíÄ</span>
    <h1>NIGHTMARE FACTORY</h1>
    <p class="tagline">YouTube Horror Automation Dashboard</p>
  </header>
  <hr class="divider">

  <!-- API KEY -->
  <div class="api-section">
    <div class="section-label">‚ö° Groq API Key</div>
    <div class="api-row">
      <div class="status-dot" id="statusDot"></div>
      <input type="password" id="apiKey" placeholder="gsk_..." />
      <button class="copy-btn" onclick="testKey()" style="white-space:nowrap;padding:10px 16px;">Test Key</button>
    </div>
    <div style="font-family:'Share Tech Mono',monospace;font-size:0.6rem;color:#444;margin-top:8px;letter-spacing:1px;">
      Get free key at console.groq.com ‚Üí API Keys ‚Üí Create API Key
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="controls-grid">
    <div class="control-box">
      <div class="section-label">ü©∏ Story Type</div>
      <select id="storyType">
        <option value="supernatural">üëª Supernatural / Ghost</option>
        <option value="psychological">üß† Psychological Horror</option>
        <option value="creature">üêç Creature / Monster</option>
        <option value="urban_legend">üåÜ Urban Legend</option>
        <option value="true_horror">üì∞ True Crime Horror</option>
        <option value="sleep_paralysis">üò¥ Sleep Paralysis</option>
        <option value="woods">üå≤ Deep Woods Horror</option>
        <option value="online">üíª Internet / Online Horror</option>
      </select>
    </div>
    <div class="control-box">
      <div class="section-label">‚è± Video Length</div>
      <select id="videoLength">
        <option value="short">Short (3-5 min) ‚Äî Shorts friendly</option>
        <option value="medium" selected>Medium (8-12 min) ‚Äî Best for ads</option>
        <option value="long">Long (15-20 min) ‚Äî Max watch time</option>
      </select>
    </div>
    <div class="control-box">
      <div class="section-label">üé≠ Tone</div>
      <select id="tone">
        <option value="slow_burn">Slow Burn & Dread</option>
        <option value="shocking">Shocking & Intense</option>
        <option value="atmospheric">Dark & Atmospheric</option>
        <option value="twist">Twist Ending</option>
      </select>
    </div>
    <div class="control-box">
      <div class="section-label">üåç Setting</div>
      <select id="setting">
        <option value="random">üé≤ Random (Recommended)</option>
        <option value="abandoned">Abandoned Building</option>
        <option value="rural">Rural Countryside</option>
        <option value="suburban">Suburban Neighborhood</option>
        <option value="forest">Dark Forest</option>
        <option value="online">The Internet</option>
        <option value="hospital">Hospital / Asylum</option>
      </select>
    </div>
  </div>

  <!-- GENERATE -->
  <button class="generate-btn" id="generateBtn" onclick="generateVideo()">
    ‚ò† GENERATE HORROR VIDEO PACKAGE ‚ò†
  </button>

  <!-- LOADING -->
  <div class="loading-bar" id="loadingBar"><div class="loading-fill" id="loadingFill"></div></div>
  <div class="loading-text" id="loadingText">SUMMONING DARKNESS...</div>

  <!-- ERROR -->
  <div class="error-msg" id="errorMsg"></div>

  <!-- OUTPUT -->
  <div class="output-section" id="outputSection">

    <!-- TITLE & HOOK -->
    <div class="output-card">
      <div class="card-header">
        <span class="card-title">üé¨ YouTube Title & Hook</span>
        <button class="copy-btn" onclick="copySection('titleContent')">Copy</button>
      </div>
      <div class="card-body" id="titleContent"></div>
    </div>

    <!-- FULL SCRIPT -->
    <div class="output-card">
      <div class="card-header">
        <span class="card-title">üìú Full Video Script (Narration)</span>
        <button class="copy-btn" onclick="copySection('scriptContent')">Copy</button>
      </div>
      <div class="card-body" id="scriptContent"></div>
    </div>

    <!-- IMAGE PROMPTS -->
    <div class="output-card">
      <div class="card-header">
        <span class="card-title">üé® AI Image Prompts (for Leonardo.ai)</span>
        <button class="copy-btn" onclick="copySection('imageContent')">Copy</button>
      </div>
      <div class="card-body mono" id="imageContent"></div>
    </div>

    <!-- MUSIC -->
    <div class="output-card">
      <div class="card-header">
        <span class="card-title">üéµ Music Prompts (for Suno.ai)</span>
        <button class="copy-btn" onclick="copySection('musicContent')">Copy</button>
      </div>
      <div class="card-body mono" id="musicContent"></div>
    </div>

    <!-- YOUTUBE META -->
    <div class="output-card">
      <div class="card-header">
        <span class="card-title">üìã YouTube Description</span>
        <button class="copy-btn" onclick="copySection('descContent')">Copy</button>
      </div>
      <div class="card-body" id="descContent"></div>
    </div>

    <!-- TAGS -->
    <div class="output-card">
      <div class="card-header">
        <span class="card-title">üè∑ YouTube Tags</span>
        <button class="copy-btn" onclick="copySection('tagsContent')">Copy</button>
      </div>
      <div class="tags-container" id="tagsContent"></div>
    </div>

    <!-- THUMBNAIL -->
    <div class="output-card">
      <div class="card-header">
        <span class="card-title">üñº Thumbnail Brief (for Canva)</span>
        <button class="copy-btn" onclick="copySection('thumbContent')">Copy</button>
      </div>
      <div class="card-body mono" id="thumbContent"></div>
    </div>


    <!-- VOICEOVER PLAYER -->
    <div class="voice-card">
      <div class="card-header" style="border-bottom:1px solid #0a1a2a;background:linear-gradient(90deg,#080d12,#050810);">
        <span class="card-title" style="color:#4a8ab4;">üéô Built-in Voiceover Player (Free, No External Site)</span>
      </div>
      <div class="voice-controls">
        <select class="voice-select" id="voiceSelect">
          <option value="">Loading voices...</option>
        </select>
        <select class="voice-select voice-speed" id="voiceSpeed">
          <option value="0.7">0.7x Slow</option>
          <option value="0.85" selected>0.85x</option>
          <option value="1.0">1.0x Normal</option>
          <option value="1.1">1.1x Fast</option>
        </select>
        <button class="voice-btn" id="playBtn" onclick="toggleVoice()">‚ñ∂ PLAY NARRATION</button>
        <button class="voice-btn" onclick="downloadVoiceScript()">‚¨á DOWNLOAD SCRIPT TXT</button>
      </div>
      <div class="voice-status" id="voiceStatus">Select a voice and click Play to hear your story narrated</div>
    </div>

    <!-- EXPORT PACKAGE -->
    <div class="output-card">
      <div class="card-header">
        <span class="card-title">üì¶ Export Your Package</span>
      </div>
      <div class="export-row">
        <button class="export-btn export-btn-srt" onclick="downloadSRT()">üìÑ Download SRT Subtitles</button>
        <button class="export-btn export-btn-txt" onclick="downloadFullTXT()">üìù Download Full Script TXT</button>
        <button class="export-btn export-btn-zip" onclick="downloadZIP()">üì¶ Download ZIP Package</button>
      </div>
    </div>

    <!-- MUSIC OPTIONS -->
    <div class="output-card">
      <div class="card-header">
        <span class="card-title">üéµ Music Mood Generator</span>
        <button class="copy-btn" onclick="copyMusicPrompt()">Copy Prompt</button>
      </div>
      <div class="music-grid" id="musicGrid">
        <div class="music-chip" onclick="selectMusic(this,'dark atmospheric orchestral horror, deep strings, no lyrics, slow tension building, cinematic')">üåë Dark Orchestral</div>
        <div class="music-chip" onclick="selectMusic(this,'creepy piano horror background, minor key, echoing notes, unsettling ambient, no lyrics')">üéπ Creepy Piano</div>
        <div class="music-chip" onclick="selectMusic(this,'supernatural horror ambient, eerie wind sounds, distant choir, haunting, no lyrics')">üëª Supernatural</div>
        <div class="music-chip" onclick="selectMusic(this,'psychological thriller music, tension building, staccato strings, no lyrics, intense')">üß† Psychological</div>
        <div class="music-chip" onclick="selectMusic(this,'deep woods horror ambient, nature sounds, owls, wind, distant growls, unsettling, no lyrics')">üå≤ Deep Woods</div>
        <div class="music-chip" onclick="selectMusic(this,'jump scare ready horror music, silent tension then sudden loud stinger, cinematic, no lyrics')">üò± Jump Scare</div>
        <div class="music-chip" onclick="selectMusic(this,'gothic horror organ music, dark medieval, ominous, no lyrics, dramatic')">‚õ™ Gothic Organ</div>
        <div class="music-chip" onclick="selectMusic(this,'digital glitch horror, distorted electronic, corrupted sounds, unsettling tech horror, no lyrics')">üíª Digital Glitch</div>
      </div>
      <div class="music-prompt-output" id="musicPromptOutput"></div>
    </div>

    <!-- VIRAL SCORE -->
    <div class="output-card">
      <div class="card-header">
        <span class="card-title">üìà Viral Potential Score</span>
      </div>
      <div style="padding:16px 0 8px;">
        <div class="score-row">
          <span class="score-label">Hook Strength</span>
          <div class="score-bar"><div class="score-fill" id="score1"></div></div>
          <span class="score-val" id="scoreVal1"></span>
        </div>
        <div class="score-row">
          <span class="score-label">Watch Time</span>
          <div class="score-bar"><div class="score-fill" id="score2"></div></div>
          <span class="score-val" id="scoreVal2"></span>
        </div>
        <div class="score-row">
          <span class="score-label">Click-Through</span>
          <div class="score-bar"><div class="score-fill" id="score3"></div></div>
          <span class="score-val" id="scoreVal3"></span>
        </div>
        <div class="score-row">
          <span class="score-label">SEO Potential</span>
          <div class="score-bar"><div class="score-fill" id="score4"></div></div>
          <span class="score-val" id="scoreVal4"></span>
        </div>
      </div>
    </div>

    <!-- PRODUCTION STEPS -->
    <div class="output-card">
      <div class="card-header">
        <span class="card-title">üõ† Your Production Checklist</span>
      </div>
      <div class="steps-grid">
        <div class="step-item"><span class="step-num">01</span><span class="step-title">Script ‚úÖ</span><span class="step-desc">Copy narration script above ‚Äî done!</span></div>
        <div class="step-item"><span class="step-num">02</span><span class="step-title">Voiceover</span><span class="step-desc">Go to ttsmp3.com ‚Üí paste script ‚Üí download MP3</span></div>
        <div class="step-item"><span class="step-num">03</span><span class="step-title">Images</span><span class="step-desc">Go to leonardo.ai ‚Üí paste image prompts above ‚Üí download</span></div>
        <div class="step-item"><span class="step-num">04</span><span class="step-title">Music</span><span class="step-desc">Go to suno.ai ‚Üí paste music prompt ‚Üí download MP3</span></div>
        <div class="step-item"><span class="step-num">05</span><span class="step-title">Assemble</span><span class="step-desc">Open CapCut ‚Üí import images + voice + music ‚Üí add auto captions</span></div>
        <div class="step-item"><span class="step-num">06</span><span class="step-title">Thumbnail</span><span class="step-desc">Open Canva ‚Üí use thumbnail brief above ‚Üí download PNG</span></div>
        <div class="step-item"><span class="step-num">07</span><span class="step-title">Upload</span><span class="step-desc">YouTube Studio ‚Üí paste title, description & tags above ‚Üí publish!</span></div>
      </div>
    </div>

    <button class="reset-btn" onclick="resetDashboard()">‚Ü∫ Generate Another Video</button>
  </div>


  <!-- HISTORY SECTION -->
  <div class="history-section" id="historySection">
    <div class="history-header">
      <span class="history-title">üìÇ Generated Packages History</span>
      <button class="clear-history-btn" onclick="clearAllHistory()">‚úï Clear All</button>
    </div>
    <div id="historyList">
      <div class="history-empty" id="historyEmpty">NO PACKAGES GENERATED YET ‚Äî HIT GENERATE TO START</div>
      <div class="history-grid" id="historyGrid"></div>
    </div>
  </div>

  <!-- HISTORY MODAL -->
  <div class="modal-overlay" id="historyModal">
    <div class="modal-box">
      <div class="modal-header">
        <span class="modal-title">‚ò† PACKAGE DETAILS</span>
        <button class="modal-close" onclick="closeModal()">‚úï Close</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <footer>nightmare factory v2.0 ¬∑ built for your horror empire ¬∑ start posting ¬∑ get monetized</footer>
</div>

<script>
let apiKeyValue = '';

async function testKey() {
  const key = document.getElementById('apiKey').value.trim();
  if (!key) { showError('Please enter your Groq API key first!'); return; }
  apiKeyValue = key;
  const dot = document.getElementById('statusDot');
  dot.style.background = '#f59e0b';
  dot.style.boxShadow = '0 0 8px #f59e0b';
  showError('');

  try {
    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${key}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'llama-3.3-70b-versatile',
        max_tokens: 10,
        messages: [{ role: 'user', content: 'Say OK' }]
      })
    });
    if (response.ok) {
      dot.className = 'status-dot connected';
      showError('‚úÖ Groq key connected! You are ready to generate videos.');
    } else {
      const err = await response.json();
      dot.className = 'status-dot error';
      showError('‚ùå Invalid key: ' + (err.error?.message || 'Check your key and try again.'));
    }
  } catch(e) {
    if (key.startsWith('gsk_')) {
      dot.className = 'status-dot connected';
      showError('‚úÖ Key format looks valid! Try generating a video.');
    } else {
      dot.className = 'status-dot error';
      showError('‚ùå Key does not look right. It should start with gsk_...');
    }
  }
}

function showError(msg) {
  const el = document.getElementById('errorMsg');
  el.textContent = msg;
  el.className = msg ? 'error-msg visible' : 'error-msg';
}

function setLoading(pct, msg) {
  document.getElementById('loadingBar').className = 'loading-bar active';
  document.getElementById('loadingText').className = 'loading-text active';
  document.getElementById('loadingFill').style.width = pct + '%';
  document.getElementById('loadingText').textContent = msg;
}

function resetDashboard() {
  document.getElementById('outputSection').className = 'output-section';
  document.getElementById('loadingBar').className = 'loading-bar';
  document.getElementById('loadingText').className = 'loading-text';
  document.getElementById('generateBtn').disabled = false;
  document.getElementById('generateBtn').textContent = '‚ò† GENERATE HORROR VIDEO PACKAGE ‚ò†';
  window.scrollTo({top: 0, behavior: 'smooth'});
}

async function generateVideo() {
  const key = document.getElementById('apiKey').value.trim();
  if (!key) { showError('‚ö† Enter your Groq API key first!'); return; }
  apiKeyValue = key;

  const storyType = document.getElementById('storyType').value;
  const videoLength = document.getElementById('videoLength').value;
  const tone = document.getElementById('tone').value;
  const setting = document.getElementById('setting').value;

  const lengthMap = { short: '400-600 words', medium: '800-1200 words', long: '1500-2000 words' };
  const wordCount = lengthMap[videoLength];

  document.getElementById('generateBtn').disabled = true;
  document.getElementById('generateBtn').textContent = '‚ò† SUMMONING...';
  showError('');
  setLoading(10, 'OPENING THE DARKNESS...');

  const prompt = `You are a viral YouTube horror content creator. Generate a complete video package for a horror YouTube channel. Return ONLY valid JSON, no markdown, no extra text.

Story type: ${storyType}
Tone: ${tone}  
Setting: ${setting === 'random' ? 'choose a compelling random setting' : setting}
Script length: ${wordCount}

Return this exact JSON structure:
{
  "title": "YouTube video title (scary, clickbait, max 60 chars, use numbers or 'I' perspective)",
  "hook": "First 2 sentences of the video - must make viewer unable to stop watching",
  "script": "Full narration script for the video (${wordCount}). Start with the hook. Write in first person. Include [PAUSE] markers for dramatic effect. Make it genuinely scary with vivid descriptions.",
  "imagePrompts": [
    "Detailed image generation prompt 1 for opening scene (dark, cinematic, horror style)",
    "Detailed image generation prompt 2 for middle scene",
    "Detailed image generation prompt 3 for climax scene",
    "Detailed image generation prompt 4 for ending scene",
    "Detailed image generation prompt 5 for atmosphere shot"
  ],
  "musicPrompt": "Suno.ai music generation prompt for background horror music (no lyrics, atmospheric)",
  "description": "YouTube video description (150-200 words, SEO optimized, include keywords, add chapters if medium/long)",
  "tags": ["tag1", "tag2", "tag3", "tag4", "tag5", "tag6", "tag7", "tag8", "tag9", "tag10", "tag11", "tag12", "tag13", "tag14", "tag15"],
  "thumbnailBrief": "Detailed Canva thumbnail design brief: background color, text to display, image description, font style, color scheme",
  "scores": {
    "hook": 85,
    "watchTime": 80,
    "clickThrough": 88,
    "seo": 75
  }
}`;

  try {
    setLoading(30, 'WRITING YOUR HORROR STORY...');

    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${key}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'llama-3.3-70b-versatile',
        max_tokens: 4000,
        temperature: 0.9,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    setLoading(70, 'CRAFTING YOUR VIDEO PACKAGE...');

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error?.message || 'Groq API request failed');
    }

    const data = await response.json();
    const raw = data.choices?.[0]?.message?.content;
    if (!raw) throw new Error('No response from Groq. Try again!');

    setLoading(90, 'ASSEMBLING THE NIGHTMARE...');

    // Parse JSON
    let result;
    try {
      const clean = raw.replace(/```json\n?/g,'').replace(/```\n?/g,'').trim();
      result = JSON.parse(clean);
    } catch(e) {
      // Try to extract JSON from response
      const match = raw.match(/\{[\s\S]*\}/);
      if (match) result = JSON.parse(match[0]);
      else throw new Error('Could not parse AI response. Try again!');
    }

    setLoading(100, 'COMPLETE.');
    setTimeout(() => renderOutput(result), 400);

  } catch(err) {
    document.getElementById('loadingBar').className = 'loading-bar';
    document.getElementById('loadingText').className = 'loading-text';
    document.getElementById('generateBtn').disabled = false;
    document.getElementById('generateBtn').textContent = '‚ò† GENERATE HORROR VIDEO PACKAGE ‚ò†';
    showError('Error: ' + err.message + ' ‚Äî Check your API key or try again.');
  }
}

function renderOutput(data) {
  // Title & Hook
  document.getElementById('titleContent').textContent = 
    `TITLE:\n${data.title}\n\nHOOK (First words of your video):\n${data.hook}`;

  // Script
  document.getElementById('scriptContent').textContent = data.script;

  // Image prompts
  const imgText = data.imagePrompts.map((p, i) => 
    `SCENE ${i+1}:\n${p}\n`
  ).join('\n');
  document.getElementById('imageContent').textContent = 
    imgText + '\n‚Üí Go to leonardo.ai ‚Üí paste each prompt ‚Üí download images';

  // Music
  document.getElementById('musicContent').textContent = 
    `MUSIC PROMPT FOR SUNO.AI:\n${data.musicPrompt}\n\n‚Üí Go to suno.ai ‚Üí paste prompt ‚Üí download MP3`;

  // Description
  document.getElementById('descContent').textContent = data.description;

  // Tags
  const tagsContainer = document.getElementById('tagsContent');
  tagsContainer.innerHTML = '';
  if (data.tags && Array.isArray(data.tags)) {
    data.tags.forEach(tag => {
      const el = document.createElement('span');
      el.className = 'tag';
      el.textContent = tag;
      tagsContainer.appendChild(el);
    });
  }

  // Thumbnail
  document.getElementById('thumbContent').textContent = 
    `THUMBNAIL DESIGN BRIEF FOR CANVA:\n${data.thumbnailBrief}\n\n‚Üí Go to canva.com ‚Üí YouTube Thumbnail ‚Üí customize based on brief above`;

  // Scores
  if (data.scores) {
    const scores = [
      { id: 1, val: data.scores.hook || 80 },
      { id: 2, val: data.scores.watchTime || 78 },
      { id: 3, val: data.scores.clickThrough || 85 },
      { id: 4, val: data.scores.seo || 72 }
    ];
    setTimeout(() => {
      scores.forEach(s => {
        document.getElementById(`score${s.id}`).style.width = s.val + '%';
        document.getElementById(`scoreVal${s.id}`).textContent = s.val + '%';
      });
    }, 300);
  }

  // Store current data for export/voiceover
  currentScript = data.script || '';
  currentPackageData = data;
  loadVoices();

  // Save to history
  saveToHistory(data, document.getElementById('storyType').value);

  // Show output
  document.getElementById('outputSection').className = 'output-section visible';
  document.getElementById('loadingBar').className = 'loading-bar';
  document.getElementById('loadingText').className = 'loading-text';
  document.getElementById('generateBtn').textContent = '‚ò† GENERATE HORROR VIDEO PACKAGE ‚ò†';

  // Scroll to output
  setTimeout(() => {
    document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 200);
}

function copySection(id) {
  const el = document.getElementById(id);
  let text = '';
  
  if (id === 'tagsContent') {
    const tags = el.querySelectorAll('.tag');
    text = Array.from(tags).map(t => t.textContent).join(', ');
  } else {
    text = el.textContent;
  }
  
  navigator.clipboard.writeText(text).then(() => {
    const btn = el.closest('.output-card').querySelector('.copy-btn');
    btn.textContent = 'Copied!';
    btn.className = 'copy-btn copied';
    setTimeout(() => {
      btn.textContent = 'Copy';
      btn.className = 'copy-btn';
    }, 2000);
  });
}



// ===== VOICEOVER PLAYER =====
let currentUtterance = null;
let isPlaying = false;
let currentScript = '';

function loadVoices() {
  const sel = document.getElementById('voiceSelect');
  if (!sel) return;
  const voices = speechSynthesis.getVoices();
  if (voices.length === 0) { setTimeout(loadVoices, 200); return; }
  sel.innerHTML = '';
  const preferred = ['Daniel','Google UK English Male','Microsoft David','Alex','Google US English','Microsoft Mark'];
  let added = [];
  // Add preferred voices first
  voices.forEach(v => {
    if (preferred.some(p => v.name.includes(p))) {
      const o = document.createElement('option');
      o.value = v.name; o.textContent = '‚≠ê ' + v.name + ' (' + v.lang + ')';
      sel.appendChild(o); added.push(v.name);
    }
  });
  // Add all others
  voices.forEach(v => {
    if (!added.includes(v.name) && v.lang.startsWith('en')) {
      const o = document.createElement('option');
      o.value = v.name; o.textContent = v.name + ' (' + v.lang + ')';
      sel.appendChild(o);
    }
  });
  if (sel.options.length === 0) {
    voices.forEach(v => {
      const o = document.createElement('option');
      o.value = v.name; o.textContent = v.name + ' (' + v.lang + ')';
      sel.appendChild(o);
    });
  }
}

speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

function toggleVoice() {
  if (isPlaying) {
    speechSynthesis.cancel();
    isPlaying = false;
    document.getElementById('playBtn').textContent = '‚ñ∂ PLAY NARRATION';
    document.getElementById('playBtn').className = 'voice-btn';
    document.getElementById('voiceStatus').textContent = 'Playback stopped.';
    return;
  }
  if (!currentScript) {
    document.getElementById('voiceStatus').textContent = '‚ö† Generate a video package first!';
    return;
  }
  const voices = speechSynthesis.getVoices();
  const selectedName = document.getElementById('voiceSelect').value;
  const voice = voices.find(v => v.name === selectedName);
  const speed = parseFloat(document.getElementById('voiceSpeed').value);
  // Clean script ‚Äî remove [PAUSE] markers for TTS
  const cleanScript = currentScript.replace(/\[PAUSE\]/g, '...').replace(/\[.*?\]/g, '');
  // Split into chunks for better browser TTS handling
  const chunks = cleanScript.match(/[^.!?]+[.!?]+/g) || [cleanScript];
  let chunkIndex = 0;
  isPlaying = true;
  document.getElementById('playBtn').textContent = '‚èπ STOP';
  document.getElementById('playBtn').className = 'voice-btn playing';
  document.getElementById('voiceStatus').textContent = 'üéô Playing narration... (' + chunks.length + ' sentences)';

  function speakNext() {
    if (!isPlaying || chunkIndex >= chunks.length) {
      isPlaying = false;
      document.getElementById('playBtn').textContent = '‚ñ∂ PLAY NARRATION';
      document.getElementById('playBtn').className = 'voice-btn';
      document.getElementById('voiceStatus').textContent = '‚úÖ Narration complete! ' + chunks.length + ' sentences played.';
      return;
    }
    const utt = new SpeechSynthesisUtterance(chunks[chunkIndex].trim());
    if (voice) utt.voice = voice;
    utt.rate = speed;
    utt.pitch = 0.85;
    utt.onend = () => { chunkIndex++; speakNext(); };
    utt.onerror = () => { chunkIndex++; speakNext(); };
    speechSynthesis.speak(utt);
    currentUtterance = utt;
  }
  speakNext();
}

function downloadVoiceScript() {
  if (!currentScript) { alert('Generate a video package first!'); return; }
  const blob = new Blob([currentScript], { type: 'text/plain' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'narration-script.txt'; a.click();
}

// ===== SRT SUBTITLE GENERATOR =====
function generateSRT(script) {
  const sentences = script.replace(/\[PAUSE\]/g,'').match(/[^.!?]+[.!?]+/g) || [];
  let srt = '';
  let time = 0;
  sentences.forEach((s, i) => {
    const words = s.trim().split(' ').length;
    const duration = Math.max(2, words * 0.45); // ~0.45 sec per word at slow pace
    const start = formatSRTTime(time);
    const end = formatSRTTime(time + duration);
    srt += (i + 1) + '\n' + start + ' --> ' + end + '\n' + s.trim() + '\n\n';
    time += duration + 0.3;
  });
  return srt;
}

function formatSRTTime(seconds) {
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = Math.floor(seconds % 60);
  const ms = Math.floor((seconds % 1) * 1000);
  return String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0') + ',' + String(ms).padStart(3,'0');
}

function downloadSRT() {
  if (!currentScript) { alert('Generate a video package first!'); return; }
  const srt = generateSRT(currentScript);
  const blob = new Blob([srt], { type: 'text/plain' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'subtitles.srt'; a.click();
}

// ===== FULL TXT DOWNLOAD =====
let currentPackageData = null;
function downloadFullTXT() {
  if (!currentPackageData) { alert('Generate a video package first!'); return; }
  const d = currentPackageData;
  const txt = [
    '=== NIGHTMARE FACTORY ‚Äî VIDEO PACKAGE ===',
    'Generated: ' + new Date().toLocaleString(),
    '',
    '=== YOUTUBE TITLE ===',
    d.title || '',
    '',
    '=== HOOK ===',
    d.hook || '',
    '',
    '=== FULL SCRIPT ===',
    d.script || '',
    '',
    '=== IMAGE PROMPTS (Leonardo.ai) ===',
    (d.imagePrompts || []).map((p,i) => 'SCENE '+(i+1)+': '+p).join('\n\n'),
    '',
    '=== MUSIC PROMPT (Suno.ai) ===',
    d.musicPrompt || '',
    '',
    '=== YOUTUBE DESCRIPTION ===',
    d.description || '',
    '',
    '=== YOUTUBE TAGS ===',
    (d.tags || []).join(', '),
    '',
    '=== THUMBNAIL BRIEF ===',
    d.thumbnailBrief || '',
    '',
    '=== SUBTITLES (SRT) ===',
    generateSRT(d.script || '')
  ].join('\n');
  const blob = new Blob([txt], { type: 'text/plain' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'video-package.txt'; a.click();
}

// ===== ZIP DOWNLOAD =====
async function downloadZIP() {
  if (!currentPackageData) { alert('Generate a video package first!'); return; }
  const d = currentPackageData;
  // Build files
  const files = {
    'script.txt': d.script || '',
    'youtube-title.txt': (d.title || '') + '\n\nHOOK:\n' + (d.hook || ''),
    'youtube-description.txt': d.description || '',
    'youtube-tags.txt': (d.tags || []).join('\n'),
    'image-prompts.txt': (d.imagePrompts || []).map((p,i) => 'SCENE '+(i+1)+':\n'+p).join('\n\n'),
    'music-prompt.txt': d.musicPrompt || '',
    'thumbnail-brief.txt': d.thumbnailBrief || '',
    'subtitles.srt': generateSRT(d.script || ''),
    'README.txt': [
      'NIGHTMARE FACTORY ‚Äî VIDEO PRODUCTION PACKAGE',
      '=============================================',
      '',
      'FILES IN THIS PACKAGE:',
      '‚Ä¢ script.txt          ‚Üí Your full narration script',
      '‚Ä¢ youtube-title.txt   ‚Üí Video title + hook',
      '‚Ä¢ youtube-description.txt ‚Üí Copy-paste YouTube description',
      '‚Ä¢ youtube-tags.txt    ‚Üí One tag per line for YouTube',
      '‚Ä¢ image-prompts.txt   ‚Üí Paste each into Leonardo.ai',
      '‚Ä¢ music-prompt.txt    ‚Üí Paste into Suno.ai',
      '‚Ä¢ thumbnail-brief.txt ‚Üí Design guide for Canva',
      '‚Ä¢ subtitles.srt       ‚Üí Drag into CapCut for auto-captions',
      '',
      'WORKFLOW:',
      '1. Paste script.txt into ttsmp3.com or use dashboard voiceover',
      '2. Paste image prompts into leonardo.ai ‚Üí download images',
      '3. Paste music prompt into suno.ai ‚Üí download MP3',
      '4. Open CapCut ‚Üí import images + voice + music',
      '5. Drag subtitles.srt ‚Üí captions auto-placed',
      '6. Export video ‚Üí upload to YouTube with title/desc/tags',
      '',
      'Generated: ' + new Date().toLocaleString()
    ].join('\n')
  };

  // Simple ZIP using manual ZIP construction
  try {
    const { default: JSZip } = await import('https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm');
    const zip = new JSZip();
    const folder = zip.folder('video-package');
    Object.entries(files).forEach(([name, content]) => folder.file(name, content));
    const blob = await zip.generateAsync({ type: 'blob' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = 'nightmare-factory-package.zip'; a.click();
  } catch(e) {
    // Fallback: download as single TXT if JSZip fails
    downloadFullTXT();
    alert('ZIP download fell back to TXT ‚Äî all content included!');
  }
}

// ===== MUSIC MOOD SELECTOR =====
let selectedMusicPrompt = '';
function selectMusic(el, prompt) {
  document.querySelectorAll('.music-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  selectedMusicPrompt = prompt;
  const out = document.getElementById('musicPromptOutput');
  out.textContent = '‚Üí SUNO PROMPT: ' + prompt;
  out.className = 'music-prompt-output visible';
}

function copyMusicPrompt() {
  const prompt = selectedMusicPrompt || document.getElementById('musicContent').textContent;
  if (!prompt) { alert('Select a music mood or generate a package first!'); return; }
  navigator.clipboard.writeText(prompt);
  const btn = document.querySelector('.output-card .copy-btn[onclick="copyMusicPrompt()"]');
  if (btn) { btn.textContent = 'Copied!'; btn.className = 'copy-btn copied'; setTimeout(()=>{ btn.textContent='Copy Prompt'; btn.className='copy-btn'; }, 2000); }
}


// ===== HISTORY SYSTEM =====
let history = JSON.parse(localStorage.getItem('nightmareHistory') || '[]');

function saveToHistory(data, storyType) {
  const entry = {
    id: Date.now(),
    date: new Date().toLocaleString('en-IN', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' }),
    storyType: storyType,
    data: data
  };
  history.unshift(entry);
  if (history.length > 50) history = history.slice(0, 50); // keep last 50
  localStorage.setItem('nightmareHistory', JSON.stringify(history));
  renderHistory();
}

function renderHistory() {
  const grid = document.getElementById('historyGrid');
  const empty = document.getElementById('historyEmpty');
  grid.innerHTML = '';

  if (history.length === 0) {
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  history.forEach((entry, idx) => {
    const card = document.createElement('div');
    card.className = 'history-card';
    card.innerHTML = `
      <button class="history-card-delete" onclick="deleteHistory(${entry.id}, event)" title="Delete">‚úï</button>
      <div class="history-card-title">${entry.data.title || 'Untitled Story'}</div>
      <div class="history-card-meta">
        <span class="history-card-date">${entry.date}</span>
        <span class="history-card-type">${entry.storyType.replace('_',' ')}</span>
      </div>
      <div class="history-view-badge">‚Üí click to view full package</div>
    `;
    card.addEventListener('click', () => openModal(entry));
    grid.appendChild(card);
  });
}

function deleteHistory(id, e) {
  e.stopPropagation();
  history = history.filter(h => h.id !== id);
  localStorage.setItem('nightmareHistory', JSON.stringify(history));
  renderHistory();
}

function clearAllHistory() {
  if (history.length === 0) return;
  if (confirm('Delete all ' + history.length + ' saved packages?')) {
    history = [];
    localStorage.setItem('nightmareHistory', '[]');
    renderHistory();
  }
}

function openModal(entry) {
  const d = entry.data;
  const body = document.getElementById('modalBody');

  let tagsHtml = '';
  if (d.tags && Array.isArray(d.tags)) {
    tagsHtml = d.tags.map(t => `<span class="tag" style="font-size:0.6rem;padding:3px 8px;">${t}</span>`).join('');
  }

  body.innerHTML = `
    <div class="modal-section">
      <div class="modal-section-header">üé¨ Title & Hook <button class="modal-copy-btn" onclick="modalCopy(this, '${escapeForAttr((d.title||'') + '\n\n' + (d.hook||''))}')">Copy</button></div>
      <div class="modal-section-body">TITLE: ${d.title||''}

HOOK: ${d.hook||''}</div>
    </div>
    <div class="modal-section">
      <div class="modal-section-header">üìú Script <button class="modal-copy-btn" onclick="modalCopy(this, '${escapeForAttr(d.script||'')}')">Copy</button></div>
      <div class="modal-section-body">${d.script||''}</div>
    </div>
    <div class="modal-section">
      <div class="modal-section-header">üé® Image Prompts <button class="modal-copy-btn" onclick="modalCopy(this, '${escapeForAttr((d.imagePrompts||[]).join('\n\n'))}')">Copy</button></div>
      <div class="modal-section-body mono">${(d.imagePrompts||[]).map((p,i)=>'SCENE '+(i+1)+':\n'+p).join('\n\n')}</div>
    </div>
    <div class="modal-section">
      <div class="modal-section-header">üéµ Music Prompt</div>
      <div class="modal-section-body mono">${d.musicPrompt||''}</div>
    </div>
    <div class="modal-section">
      <div class="modal-section-header">üìã Description <button class="modal-copy-btn" onclick="modalCopy(this, '${escapeForAttr(d.description||'')}')">Copy</button></div>
      <div class="modal-section-body">${d.description||''}</div>
    </div>
    <div class="modal-section">
      <div class="modal-section-header">üè∑ Tags</div>
      <div class="modal-tags">${tagsHtml}</div>
    </div>
    <div class="modal-section">
      <div class="modal-section-header">üñº Thumbnail Brief</div>
      <div class="modal-section-body mono">${d.thumbnailBrief||''}</div>
    </div>
  `;

  document.getElementById('historyModal').className = 'modal-overlay active';
}

function escapeForAttr(str) {
  return (str||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/\n/g,'\\n').replace(/"/g,'&quot;');
}

function closeModal() {
  document.getElementById('historyModal').className = 'modal-overlay';
}

function modalCopy(btn, text) {
  const decoded = text.replace(/\\n/g,'\n').replace(/\\'/g,"'");
  navigator.clipboard.writeText(decoded).then(() => {
    btn.textContent = 'Copied!';
    btn.className = 'modal-copy-btn copied';
    setTimeout(() => { btn.textContent = 'Copy'; btn.className = 'modal-copy-btn'; }, 2000);
  });
}

// Close modal on overlay click
document.getElementById('historyModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

// Init history on load
renderHistory();

</script>
</body>
</html>
